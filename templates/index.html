{% extends "layout.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<h2 class="mb-4">Dashboard</h2>

<!-- Financial Summary Row -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white h-100">
            <div class="card-body">
                <h5 class="card-title">Projects</h5>
                <p class="card-text display-4 mb-0">{{ total_projects }}</p>
                <small class="text-white-50">{{ active_projects }} active</small>
            </div>
            <div class="card-footer bg-primary border-0 text-end">
                <a href="{{ url_for('projects') }}" class="btn btn-outline-light btn-sm">View All</a>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white h-100">
            <div class="card-body">
                <h5 class="card-title">Invoiced Amount</h5>
                <p class="card-text display-4 mb-0">${{ "%.2f"|format(total_invoiced) }}</p>
            </div>
            <div class="card-footer bg-success border-0 text-end">
                <a href="{{ url_for('invoices') }}" class="btn btn-outline-light btn-sm">View Invoices</a>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark h-100">
            <div class="card-body">
                <h5 class="card-title">Unpaid Invoices</h5>
                <p class="card-text display-4 mb-0">${{ "%.2f"|format(unpaid_invoices) }}</p>
            </div>
            <div class="card-footer bg-warning border-0 text-end">
                <a href="{{ url_for('invoices') }}" class="btn btn-outline-dark btn-sm">Review</a>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white h-100">
            <div class="card-body">
                <h5 class="card-title">Weekly Hours</h5>
                <p class="card-text display-4 mb-0">{{ "%.1f"|format(weekly_hours) }}</p>
            </div>
            <div class="card-footer bg-info border-0 text-end">
                <a href="{{ url_for('payroll_report') }}" class="btn btn-outline-light btn-sm">Payroll Report</a>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Project Status Pie Chart -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Project Status Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="projectStatusChart" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Monthly Expenses Line Chart -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Monthly Expense Trend</h5>
            </div>
            <div class="card-body">
                <canvas id="expensesChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Top Projects and Quick Links Row -->
<div class="row mb-4">
    <!-- Top Profitable Projects -->
    <div class="col-md-7">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Top Performing Projects</h5>
            </div>
            <div class="card-body">
                {% if top_projects %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Project</th>
                                <th>Client</th>
                                <th>Contract Value</th>
                                <th>Profit Margin</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for project in top_projects %}
                            <tr>
                                <td><a href="{{ url_for('project_detail', id=project.id) }}">{{ project.name }}</a></td>
                                <td>{{ project.client_name }}</td>
                                <td>${{ "%.2f"|format(project.contract_value or 0) }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                            <div class="progress-bar {% if project.profit_margin >= 20 %}bg-success{% elif project.profit_margin >= 0 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                role="progressbar" 
                                                style="width: {{ project.progress_width }}%">
                                            </div>
                                        </div>
                                        <span>{{ "%.1f"|format(project.profit_margin or 0) }}%</span>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="card-text">No active projects found.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Quick Links -->
    <div class="col-md-5">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row row-cols-1 row-cols-lg-2 g-3">
                    <div class="col">
                        <a href="{{ url_for('add_timesheet') }}" class="btn btn-primary d-block">
                            <i class="bi bi-clock"></i> Add Timesheet
                        </a>
                    </div>
                    <div class="col">
                        <a href="{{ url_for('add_project') }}" class="btn btn-success d-block">
                            <i class="bi bi-building"></i> New Project
                        </a>
                    </div>
                    <div class="col">
                        <a href="{{ url_for('add_expense') }}" class="btn btn-warning d-block">
                            <i class="bi bi-cash"></i> Add Expense
                        </a>
                    </div>
                    <div class="col">
                        <a href="{{ url_for('add_invoice') }}" class="btn btn-info d-block text-white">
                            <i class="bi bi-receipt"></i> New Invoice
                        </a>
                    </div>
                    <div class="col">
                        <a href="{{ url_for('employees') }}" class="btn btn-secondary d-block">
                            <i class="bi bi-people"></i> Employees
                        </a>
                    </div>
                    <div class="col">
                        <a href="{{ url_for('record_payroll_payment') }}" class="btn btn-dark d-block">
                            <i class="bi bi-credit-card"></i> Record Payment
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Expenses Table -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="card-title mb-0">Recent Expenses</h5>
    </div>
    <div class="card-body">
        {% if recent_expenses %}
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Category</th>
                        <th>Amount</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for expense in recent_expenses %}
                    <tr>
                        <td>{{ expense.date.strftime('%Y-%m-%d') }}</td>
                        <td>{{ expense.description }}</td>
                        <td>{{ expense.category }}</td>
                        <td>${{ "%.2f"|format(expense.amount) }}</td>
                        <td><span class="badge bg-{% if expense.payment_status.name == 'PAID' %}success{% elif expense.payment_status.name == 'PENDING' %}warning{% else %}secondary{% endif %}">{{ expense.payment_status.value }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="card-text">No recent expenses recorded.</p>
        {% endif %}
    </div>
    <div class="card-footer bg-white text-end">
        <a href="{{ url_for('expenses') }}" class="btn btn-sm btn-outline-secondary">View All Expenses</a>
    </div>
</div>

<!-- JavaScript for Charts -->
<script>
    // Project Status Chart
    const projectStatusCtx = document.getElementById('projectStatusChart').getContext('2d');
    const projectStatusChart = new Chart(projectStatusCtx, {
        type: 'doughnut',
        data: {
            labels: [
                {% for status in project_status_counts %}
                    '{{ status }}',
                {% endfor %}
            ],
            datasets: [{
                data: [
                    {% for status, count in project_status_counts.items() %}
                        {{ count }},
                    {% endfor %}
                ],
                backgroundColor: [
                    '#007bff', '#28a745', '#17a2b8', '#ffc107', '#dc3545', '#6c757d'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                }
            }
        }
    });

    // Monthly Expenses Chart
    const expensesCtx = document.getElementById('expensesChart').getContext('2d');
    const expensesChart = new Chart(expensesCtx, {
        type: 'line',
        data: {
            labels: {{ monthly_labels|tojson }},
            datasets: [{
                label: 'Monthly Expenses ($)',
                data: {{ monthly_expenses|tojson }},
                fill: false,
                borderColor: '#dc3545',
                tension: 0.1,
                pointBackgroundColor: '#dc3545'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value;
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}